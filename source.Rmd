---
title: "기상 특보"
output:
  html_document:
    toc: yes
    toc_float: yes
    keep_md: yes
  pdf_document:
    toc: yes
---
```{r setup, include=FALSE, warning=FALSE, echo = FALSE, dpi = 300}
knitr::opts_chunk$set(echo = TRUE)
knitr:::input_dir()
```

```{r, warning= FALSE, message=F, echo = FALSE}
#분석하고자 하는 csv데이터를 sdot이라는 데이터 프레임에 넣기 
#라이브러리 로드 순서는 절대 변경되면 안됩니다. 
library(dplyr)
library(scales)
library(rgdal)
library(raster)
library(reactable)
library(flexdashboard)
library(ggmap)
library(ggplot2)
library(raster)
library(rgeos)
library(maptools)
library(rgdal)
#library(readAny)
library(raster)
library(leaflet)
library(lubridate)
library(data.table)
library(purrr)
library(tidyverse)
library(feather)
library(mapview)
library(leaflet.extras)
library(multidplyr)
library(geosphere)
library(DataExplorer)
library(formattable)
options(digits = 1)
options(scipen=100)
library(ggplot2)
library(gridExtra)  
library(ggpubr)
library(ggridges)
library(ggplot2)
library(viridis)
library(hrbrthemes)
library(leaflet.extras)
library(gganimate) #plotly 적요이
library(gapminder)
library(transformr)
#library(gifski)
#library(rstudioapi)
library(plotly)
```


```{r, warning= FALSE, message=F, echo = FALSE}
####디렉토리 설정 ######
#07.29 상대 디렉토리 변경 



###########################################################################
###########################날짜입력########################################



#data폴더와 data2폴더에 비교하고자 하는 sdot1시간 데이터를 각각 넣어야함

#20년도 시작일자를 입력해주세요

# year_2020   <-  readline('20년도 분석 시작일을 입력해주세요(yyyy-mm-dd) : ')
# 
# year_2020_2 <-  readline('20년도 분석 종료일을 입력해주세요(yyyy-mm-dd) : ')
# 
# year_2021   <-  readline('21년도 분석 시작일을 입력해주세요(yyyy-mm-dd) : ')
# 
# year_2021_2 <-  readline('21년도 분석 종료일을 입력해주세요(yyyy-mm-dd) : ')
# 
# 
# year_len <- readline('총 분석 기간을 숫자로 입력해주세요 : ')
# year_len <- as.integer(year_len)


year_2020   <-  "2020-07-01"
year_2020_2 <-  "2020-07-04"

year_2021   <-  "2021-07-01"
year_2021_2 <-  "2021-07-04"


year_len <- 4
###########################################################################
###########################################################################
iv_len <- 4
source('custom_fun.R')
 

##실효습도 계산에 필요한 일자 추출
##이후 해당 날짜 데이터만 읽어오기


date_tsv1 <- as.Date(year_2020) %>% as.character() %>% str_replace_all('-','')
date_tsv2 <- as.Date(year_2021) %>% as.character() %>% str_replace_all('-','')


#실효습도 계산에 필요한 데이터  시작일 계산 
date_h1 <- as.Date(year_2020) %>% -days(4) %>% as.character() %>% str_replace_all('-','')
date_h2 <- as.Date(year_2021) %>% -days(4) %>% as.character() %>% str_replace_all('-','')



#20년도 실효습도 데이터   

getwd()
setwd("data/2020년 데이터")
tyu1 <- list.files(pattern = "ALL")
ny1 <- str_sub(tyu1,9,16)

h_start_2020 <- find_index(ny1,date_h1)

h1_data <- tyu1[h_start_2020:(h_start_2020+iv_len+4-1)] %>% map_df(~read.csv(.,head = TRUE, check.names = FALSE, fileEncoding = 'euc-kr')) %>% as_tibble()
names(h1_data) <- c("모델명", "시리얼", "구분", "초미세먼지 (㎍/㎥)", "미세먼지 (㎍/㎥)", "기온 (℃)", "상대습도 (%)", "풍향 (°)", "풍속 (m/s)", "돌풍 풍향 (°)", "돌풍 풍속 (m/s)", "조도 (lux)", "자외선 (UVI)", "소음 (dB)", "진동(x) (g)","진동(y) (g)","진동(z) (g)","진동(x) 최대 (g)","진동(y) 최대 (g)","진동(z) 최대 (g)","흑구 온도 (℃)","초미세먼지 보정 (㎍/㎥)","미세먼지 보정 (㎍/㎥)",
                "측정시간","등록 일시","date")
h1_data$date <- NULL

#21년도 실효습도 데이터 

getwd()
setwd("..")
setwd("..")
getwd()
setwd("data2/2021년 데이터")
tyu2 <- list.files(pattern = "ALL")
ny2 <- str_sub(tyu2,9,16)

h_start_2021 <- find_index(ny2,date_h2)


h2_data <- tyu2[h_start_2021:(h_start_2021+iv_len+4-1)] %>% map_df(~read.csv(.,head = TRUE, check.names = FALSE, fileEncoding = 'euc-kr')) %>% as_tibble()

z <- h2_data
z <- z[-25:-30]

names(z) <- c("모델명", "시리얼", "구분", "초미세먼지 (㎍/㎥)", "미세먼지 (㎍/㎥)", "기온 (℃)", "상대습도 (%)", "풍향 (°)", "풍속 (m/s)", "돌풍 풍향 (°)", "돌풍 풍속 (m/s)", "조도 (lux)", "자외선 (UVI)", "소음 (dB)", "진동(x) (g)","진동(y) (g)","진동(z) (g)","진동(x) 최대 (g)","진동(y) 최대 (g)","진동(z) 최대 (g)","흑구 온도 (℃)","초미세먼지 보정 (㎍/㎥)","미세먼지 보정 (㎍/㎥)",
"측정시간","등록 일시")

h2_data <- z


#######
#2020년 전체데이터

tsv_start_2020 <- find_index(ny1,date_tsv1)

setwd("..")
setwd("..")
setwd("data/2020년 데이터")
#tsv <- list.files(pattern = "ALL") %>% map_df(~read.csv(.,head = TRUE, check.names = FALSE, fileEncoding = 'euc-kr')) %>% as_tibble()

tsv <- tyu1[tsv_start_2020:(tsv_start_2020+year_len-1)] %>% map_df(~read.csv(.,head = TRUE, check.names = FALSE, fileEncoding = 'euc-kr')) %>% as_tibble()


names(tsv) <- c("모델명", "시리얼", "구분", "초미세먼지 (㎍/㎥)", "미세먼지 (㎍/㎥)", "기온 (℃)", "상대습도 (%)", "풍향 (°)", "풍속 (m/s)", "돌풍 풍향 (°)", "돌풍 풍속 (m/s)", "조도 (lux)", "자외선 (UVI)", "소음 (dB)", "진동(x) (g)","진동(y) (g)","진동(z) (g)","진동(x) 최대 (g)","진동(y) 최대 (g)","진동(z) 최대 (g)","흑구 온도 (℃)","초미세먼지 보정 (㎍/㎥)","미세먼지 보정 (㎍/㎥)",
                "측정시간","등록 일시","date")
tsv$date <-NULL


tsv_start_2021 <- find_index(ny2,date_tsv2)
setwd("..")
setwd("..")
setwd("data2/2021년 데이터")
data4 <- tyu2[tsv_start_2021:(tsv_start_2021+year_len-1)] %>% map_df(~read.csv(.,head = TRUE, check.names = FALSE, fileEncoding = 'euc-kr')) %>% as_tibble()



z <-data4
z <- z[-25:-30]

names(z) <- c("모델명", "시리얼", "구분", "초미세먼지 (㎍/㎥)", "미세먼지 (㎍/㎥)", "기온 (℃)", "상대습도 (%)", "풍향 (°)", "풍속 (m/s)", "돌풍 풍향 (°)", "돌풍 풍속 (m/s)", "조도 (lux)", "자외선 (UVI)", "소음 (dB)", "진동(x) (g)","진동(y) (g)","진동(z) (g)","진동(x) 최대 (g)","진동(y) 최대 (g)","진동(z) 최대 (g)","흑구 온도 (℃)","초미세먼지 보정 (㎍/㎥)","미세먼지 보정 (㎍/㎥)",
"측정시간","등록 일시")

#TSV -> DATA FOLDER: OLD DATA(20)
#Z -> DATA 2 FOLDER: NOW DATA(21)
tsv<-rbind(tsv, z)

h_data <- rbind(h1_data,h2_data)
#TSV -> 21,21 DATA RBIND


# tsv<-read.csv("test.csv", fileEncoding = 'euc-kr',  head=TRUE, check.names = FALSE)
# tsv$date <-NULL
# names(tsv) <- c("모델명", "시리얼", "구분", "초미세먼지 (㎍/㎥)", "미세먼지 (㎍/㎥)", "기온 (℃)", "상대습도 (%)", "풍향 (°)", "풍속 (m/s)", "돌풍 풍향 (°)", "돌풍 풍속 (m/s)", "조도 (lux)", "자외선 (UVI)", "소음 (dB)", "진동(x) (g)","진동(y) (g)","진동(z) (g)","진동(x) 최대 (g)","진동(y) 최대 (g)","진동(z) 최대 (g)","흑구 온도 (℃)","미세먼지 보정 (㎍/㎥)", "초미세먼지 보정 (㎍/㎥)",
# "측정시간","등록 일시")

setwd("..")
setwd("..")
setwd("basic_data")
model <- read.csv("model.csv", head=TRUE, fileEncoding = 'euc-kr', check.names = FALSE)

model$No <-NULL
#model <-model %>% filter(!set ==999)
model <- model %>% dplyr::rename(시리얼 = model)

sdot_hour_data <- merge(tsv, model, by ="시리얼", all.x = TRUE)
h_hour_data<- merge(h_data, model, by ="시리얼", all.x = TRUE)



sdot_hour_data <- sdot_hour_data %>% dplyr::rename(long = y, lat = x)
h_hour_data <- h_hour_data %>% dplyr::rename(long = y, lat = x)


sample<-read.csv("sample.csv", head=TRUE, fileEncoding = 'euc-kr')
sample$A <-NULL
sample$B <-NULL
sample <- sample %>% dplyr::rename(gover = 시군구명)
tsv <- merge(sdot_hour_data, sample, by ="gover", all.x = TRUE)
h_data <- merge(h_hour_data, sample, by ="gover", all.x = TRUE)

###########2021년 시리얼 ########
model2 <- read_csv("model2.csv")
model2 <- model2 %>% dplyr::rename(시리얼 = model)

tsv <- merge(tsv, model2, by ="시리얼", all.x = TRUE)
h_data <- merge(h_data, model2, by ="시리얼", all.x = TRUE)

####################################





















rm(z)
rm(data4)
rm(model)
rm(model2)
rm(sample)
rm(sdot_hour_data)
rm(h1_hour_data)
rm(h2_hour_data)
gc()

tsv$`등록 일시` <- ymd_hms(tsv$`등록 일시`)
tsv$`등록 일시` <-format(as.POSIXct(tsv$`등록 일시`), "%Y-%m-%d %H:00:00")
tsv$측정시간 <- tsv$`등록 일시`
tsv$측정시간 <-format(as.POSIXct(tsv$측정시간), "%Y-%m-%d %H:00:00")
tsv$측정시간 <- ymd_hms(tsv$측정시간)
tsv$`등록 일시` <- ymd_hms(tsv$`등록 일시`)

tsv$date <-as.Date(tsv$측정시간)
tsv$year<-year(tsv$date)

#####
h_data$`등록 일시` <- ymd_hms(h_data$`등록 일시`)
h_data$`등록 일시` <-format(as.POSIXct(h_data$`등록 일시`), "%Y-%m-%d %H:00:00")
h_data$측정시간 <- h_data$`등록 일시`
h_data$측정시간 <-format(as.POSIXct(h_data$측정시간), "%Y-%m-%d %H:00:00")
h_data$측정시간 <- ymd_hms(h_data$측정시간)
h_data$`등록 일시` <- ymd_hms(h_data$`등록 일시`)

h_data$date <-as.Date(h_data$측정시간)
h_data$year<-year(h_data$date)

#######


#####
#tsv는 측정 데이터를 전부 다 가지고 있는 테이블 이며 

#미세먼지 값은 전부 첫째자리에서 반올림,초미세 역시 동일  
tsv[,'초미세먼지 보정 (㎍/㎥)'] = round(tsv[,'초미세먼지 보정 (㎍/㎥)'],0)
tsv[,'미세먼지 보정 (㎍/㎥)'] = round(tsv[,'미세먼지 보정 (㎍/㎥)'],0)

#음수 측정값 제거
tsv <- tsv[tsv$'미세먼지 보정 (㎍/㎥)'>=0,]
tsv <- tsv[tsv$'초미세먼지 보정 (㎍/㎥)'>=0,]



tsv_1 <- tsv %>% filter(date >= year_2020 & date <= year_2020_2)
tsv_2 <- tsv %>% filter(date >= year_2021 & date <= year_2021_2)
tsv_2 <- tsv_2 %>% filter(!is.na(gover))


h1_start_date <-(as.Date(year_2020) - days(4)) %>% as.character()
h2_start_date <- (as.Date(year_2021) - days(4)) %>% as.character()

h_1 <- h_data %>% filter(date >= h1_start_date & date <= year_2020_2)
h_2 <- h_data %>% filter(date >= h2_start_date & date <= year_2021_2)
h_2 <- h_2 %>% filter(!is.na(gover))

rm(tsv)
rm(h_data)
rm(h_start_2020)
rm(h_start_2021)
rm(date_h1)
rm(date_h2)
rm(h1_data)
rm(h2_data)
rm(ny1)
rm(ny2)

#이 시점에서 tsv1 -> 20년도 데이터 이며
#tsv2 -> 21년도 데이터 이다. 
# year_2020_2 등은 변수로 6일과 9일 사이의 데이터만 따로 추출한 것이다. 


#tsv %>% filter(date =="2021-05-06")
  
# tsv_2$`미세먼지 보정 (㎍/㎥)2`<-tsv_2$`미세먼지 보정 (㎍/㎥)`
# tsv_2$`미세먼지 보정 (㎍/㎥)`<-tsv_2$`초미세먼지 보정 (㎍/㎥)`
# tsv_2$`초미세먼지 보정 (㎍/㎥)`<-tsv_2$`미세먼지 보정 (㎍/㎥)2`
# tsv_2$`미세먼지 보정 (㎍/㎥)2` <-NULL
# tsv_2$`초미세먼지 보정 (㎍/㎥)2` <-NULL

tsv_1$`미세먼지 보정 (㎍/㎥)` <-ceiling(tsv_1$`미세먼지 보정 (㎍/㎥)`)
tsv_1$`초미세먼지 보정 (㎍/㎥)` <-ceiling(tsv_1$`초미세먼지 보정 (㎍/㎥)`)

tsv_2$`미세먼지 보정 (㎍/㎥)` <- ceiling(tsv_2$`미세먼지 보정 (㎍/㎥)`)
tsv_2$`초미세먼지 보정 (㎍/㎥)` <-ceiling(tsv_2$`초미세먼지 보정 (㎍/㎥)`)




#일별미세먼지
tsv_1_seoul <- tsv_1 %>% group_by(date) %>% summarise(미세먼지 =mean(`미세먼지 보정 (㎍/㎥)`, na.rm =TRUE ),초미세먼지 =mean(`초미세먼지 보정 (㎍/㎥)`, na.rm =TRUE))
tsv_2_seoul <- tsv_2 %>% group_by(date) %>% summarise(미세먼지 =mean(`미세먼지 보정 (㎍/㎥)`, na.rm =TRUE ),초미세먼지 =mean(`초미세먼지 보정 (㎍/㎥)`, na.rm =TRUE))

#1->20년도 데이터 미세 초미세 둘다 포함 
#2->21년도 데이터 미세 초미세 둘다 포함

#일별 기온과 습도
tsv_1_seoul_temp <- tsv_1 %>% group_by(date) %>% summarise(기온 = mean(`기온 (℃)`, na.rm = TRUE ) )
tsv_1_seoul_humid <- tsv_1 %>% group_by(date) %>% summarise(습도 = mean(`상대습도 (%)`, na.rm = TRUE ) )

tsv_2_seoul_temp <- tsv_2 %>% group_by(date) %>% summarise(기온 = mean(`기온 (℃)`, na.rm = TRUE ) )
tsv_2_seoul_humid <- tsv_2 %>% group_by(date) %>% summarise(습도 = mean(`상대습도 (%)`, na.rm = TRUE ) )




#일별 미세초미세먼지 melt
tsv_1_seoul <- melt(tsv_1_seoul, id.vars='date')
tsv_2_seoul <- melt(tsv_2_seoul, id.vars='date')

tsv_3_seoul<-rbind(tsv_1_seoul, tsv_2_seoul)

#일별 온습도

tsv_1_seoul_temp <-  melt(tsv_1_seoul_temp, id.vars='date')
tsv_1_seoul_humid <-  melt(tsv_1_seoul_humid, id.vars='date')


tsv_1_seoul_temp$date <- as.factor(tsv_1_seoul_temp$date)
tsv_2_seoul_temp$date <- as.factor(tsv_2_seoul_temp$date)

tsv_2_seoul_temp <- melt(tsv_2_seoul_temp, id.vars='date')
tsv_2_seoul_humid <- melt(tsv_2_seoul_humid, id.vars='date')

tsv_1_seoul_humid$date <- as.factor(tsv_1_seoul_humid$date)
tsv_2_seoul_humid$date <- as.factor(tsv_2_seoul_humid$date)


```





# 서울시 일별 온습도, 미세먼지 막대그래프
```{r, warning= FALSE, message=F, echo = FALSE, dpi=200, fig.width=5, fig.height=5}

#20년도 일별 기온 그래프
ggplot(tsv_1_seoul_temp, aes(x=date, y=value, fill=variable)) +
  geom_bar(stat="identity",show.legend=TRUE, colour="black",width = 0.3) +
    geom_text(aes(y=value, label = format(round(value, 0), nsmall=0)), size=4 ,position=position_dodge(width=0.9), vjust=-0.25) +
    ylim(0,30)+
  ylab('20년도 서울시 일별 기온') 

#21년도 일별 기온 그래프 
ggplot(tsv_2_seoul_temp, aes(x=date, y=value, fill=variable)) +
  geom_bar(stat="identity",show.legend=TRUE, colour="black",width = 0.3) +
    geom_text(aes(y=value, label = format(round(value, 0), nsmall=0)), size=4 ,position=position_dodge(width=0.9), vjust=-0.25) +
    ylim(0,30)+
  ylab('21년도 서울시 일별 기온') 

 

#20년도 일별 습도 그래프
ggplot(tsv_1_seoul_humid, aes(x=date, y=value, fill=variable)) +
  geom_bar(stat="identity",show.legend=TRUE, colour="black",width = 0.3,fill = 'royalblue') +
    geom_text(aes(y=value, label = format(round(value, 0), nsmall=0)), size=4 ,position=position_dodge(width=0.9), vjust=-0.25) +
    ylim(0,100)+
  ylab('20년도 서울시 일별 습도') 



#21년도 일별 습도 그래프
ggplot(tsv_2_seoul_humid, aes(x=date, y=value, fill=variable)) +
  geom_bar(stat="identity",show.legend=TRUE, colour="black",width = 0.3,fill = 'royalblue') +
    geom_text(aes(y=value, label = format(round(value, 0), nsmall=0)), size=4 ,position=position_dodge(width=0.9), vjust=-0.25) +
    ylim(0,100)+
  ylab('21년도 서울시 일별 습도') 

rm(tsv_1_seoul_humid)
rm(tsv_1_seoul_temp)
rm(tsv_2_seoul_humid)
rm(tsv_2_seoul_temp)

gc()

```



# 서울시 시간별 온습도, 미세먼지 꺾은선 그래프
```{r, warning= FALSE, message=F, echo = FALSE, dpi=300, fig.width=7}


#일별_시간별_온습도_평균데이터
tsv_1_seoul_hour_temp <- tsv_1 %>% group_by(측정시간,date) %>% summarise(기온 =mean(`기온 (℃)`, na.rm =TRUE ))
tsv_2_seoul_hour_temp <- tsv_2 %>% group_by(측정시간,date) %>% summarise(기온 =mean(`기온 (℃)`, na.rm =TRUE ))

tsv_1_seoul_hour_humid <- tsv_1 %>% group_by(측정시간,date) %>% summarise(습도 =mean(`상대습도 (%)`, na.rm =TRUE ))
tsv_2_seoul_hour_humid <- tsv_2 %>% group_by(측정시간,date) %>% summarise(습도 =mean(`상대습도 (%)`, na.rm =TRUE ))


#일별_시간별_온습도_반올림
tsv_1_seoul_hour_temp$기온 <- round(tsv_1_seoul_hour_temp$기온) 
tsv_2_seoul_hour_temp$기온 <- round(tsv_2_seoul_hour_temp$기온) 

tsv_1_seoul_hour_humid$습도 <- round(tsv_1_seoul_hour_humid$습도) 
tsv_2_seoul_hour_humid$습도 <- round(tsv_2_seoul_hour_humid$습도) 


#서울시 전체 시간별 온도 2020
p_seoul_hour_temp1 <- ggplot(tsv_1_seoul_hour_temp, aes(x=측정시간)) + 
  
  geom_line(aes(y = 기온), color = "red", linetype="solid") + 
  geom_point(aes(y = 기온), colour = "steelblue", size = 0.7) +
  
  geom_text(aes(y=기온,label= round(기온, digits = 0)), vjust = -3, size = 2) +
  theme(legend.position = "right") +
  #scale_color_manual(values = c('Y1' = 'darkblue','Y2' = 'red')) + labs(color = 'Y series') +
  
  #scale_x_date(date_breaks = "day", date_labels =  "%y-%m-%d") +
  
  ggtitle(paste0(year_2020,"~",year_2020_2, "서울 시간별 평균 기온"))  + ylab("기온") +
  theme_bw() +
  theme(text=element_text(family="NanumGothic"),axis.text.x = element_text(angle=90, hjust=1)) +
  scale_x_datetime( date_breaks= "6 hour", date_minor_breaks= "2 hours",
                    labels = date_format("%y-%m-%d %H:%M", tz= "UTC"), 
                    expand = c(0,0))

#서울시 전체 시간별 온도 2021
p_seoul_hour_temp2 <- ggplot(tsv_2_seoul_hour_temp, aes(x=측정시간)) + 
  
  geom_line(aes(y = 기온), color = "red", linetype="solid") + 
  geom_point(aes(y = 기온), colour = "steelblue", size = 0.7) +
  
  geom_text(aes(y=기온,label= round(기온, digits = 0)), vjust = -3, size = 2) +
  theme(legend.position = "right") +
  #scale_color_manual(values = c('Y1' = 'darkblue','Y2' = 'red')) + labs(color = 'Y series') +
  
  #scale_x_date(date_breaks = "day", date_labels =  "%y-%m-%d") +
  
  ggtitle(paste0(year_2021,"~",year_2021_2, "서울 시간별 평균 기온"))  + ylab("기온") +
  theme_bw() +
  theme(text=element_text(family="NanumGothic"),axis.text.x = element_text(angle=90, hjust=1)) +
  scale_x_datetime( date_breaks= "6 hour", date_minor_breaks= "2 hours",
                    labels = date_format("%y-%m-%d %H:%M", tz= "UTC"), 
                                        expand = c(0,0))


#서울시 전체 시간별 습도 2020
p_seoul_hour_humid1 <- ggplot(tsv_1_seoul_hour_humid, aes(x=측정시간)) + 
  
  geom_line(aes(y = 습도), color = "royalblue", linetype="solid") + 
  geom_point(aes(y = 습도), colour = "steelblue", size = 0.7) +
  
  geom_text(aes(y=습도,label= round(습도, digits = 0)), vjust = -3, size = 2) +
  theme(legend.position = "right") +
  #scale_color_manual(values = c('Y1' = 'darkroyalblue','Y2' = 'red')) + labs(color = 'Y series') +
  
  #scale_x_date(date_breaks = "day", date_labels =  "%y-%m-%d") +
  
  ggtitle(paste0(year_2020,"~",year_2020_2, "서울 시간별 평균 상대습도"))  + ylab("습도") +
  theme_bw() +
  theme(text=element_text(family="NanumGothic"),axis.text.x = element_text(angle=90, hjust=1)) +
  scale_x_datetime( date_breaks= "6 hour", date_minor_breaks= "2 hours",
                    labels = date_format("%y-%m-%d %H:%M", tz= "UTC"), 
                    expand = c(0,0))


#서울시 전체 시간별 습도 2021
p_seoul_hour_humid2 <- ggplot(tsv_2_seoul_hour_humid, aes(x=측정시간)) + 
  
  geom_line(aes(y = 습도), color = "royalblue", linetype="solid") + 
  geom_point(aes(y = 습도), colour = "steelblue", size = 0.7) +
  
  geom_text(aes(y=습도,label= round(습도, digits = 0)), vjust = -3, size = 2) +
  theme(legend.position = "right") +
  #scale_color_manual(values = c('Y1' = 'darkroyalblue','Y2' = 'red')) + labs(color = 'Y series') +
  
  #scale_x_date(date_breaks = "day", date_labels =  "%y-%m-%d") +
  
  ggtitle(paste0(year_2021,"~",year_2021_2, "서울 시간별 평균 상대습도"))  + ylab("습도") +
  theme_bw() +
  theme(text=element_text(family="NanumGothic"),axis.text.x = element_text(angle=90, hjust=1)) +
  scale_x_datetime( date_breaks= "6 hour", date_minor_breaks= "2 hours",
                    labels = date_format("%y-%m-%d %H:%M", tz= "UTC"), 
                    expand = c(0,0))



p_seoul_hour_temp1
p_seoul_hour_temp2
p_seoul_hour_humid1
p_seoul_hour_humid2

rm(p_seoul_hour_temp1)
rm(p_seoul_hour_temp2)
rm(p_seoul_hour_humid1)
rm(p_seoul_hour_humid2)




gc()


tsv_1_seoul_hour_humid 

#2020
max_temp_tsv_1_seoul_hour <- max(tsv_1_seoul_hour_temp$기온) 
max_humid_tsv_1_seoul_hour <- max(tsv_1_seoul_hour_humid$습도) 

asdf <- tsv_1_seoul_hour_temp %>% filter(기온 == max_temp_tsv_1_seoul_hour) %>% dplyr::select(측정시간)
asdf2 <- tsv_1_seoul_hour_humid %>% filter(습도 == max_humid_tsv_1_seoul_hour) %>% dplyr::select(측정시간)

#mean_pm10_tsv_1_seoul_hour <- mean(tsv_1_seoul_hour$미세먼지) 
#mean_pm2_tsv_1_seoul_hour <- mean(tsv_1_seoul_hour$초미세먼지) 


#asdf <- tsv_1_seoul_hour %>% filter(미세먼지 == max_pm10_tsv_1_seoul_hour) %>% dplyr::select(측정시간)
#asdf2 <- tsv_1_seoul_hour %>% filter(초미세먼지 == max_pm2_tsv_1_seoul_hour) %>% dplyr::select(측정시간)


#2021
max_temp_tsv_2_seoul_hour <- max(tsv_2_seoul_hour_temp$기온) 
max_humid_tsv_2_seoul_hour <- max(tsv_2_seoul_hour_humid$습도) 

asdf3 <- tsv_2_seoul_hour_temp %>% filter(기온 == max_temp_tsv_2_seoul_hour) %>% dplyr::select(측정시간)
asdf4 <- tsv_2_seoul_hour_humid %>% filter(습도 == max_humid_tsv_2_seoul_hour) %>% dplyr::select(측정시간)







#paste0('**',tau,'**')
```

`r year_2020` ~ `r year_2020_2`에서 기온, 습도가 가장 높은 값은 각각 
`r paste0('**',max_temp_tsv_1_seoul_hour,'**')`, 
`r paste0('**',max_humid_tsv_1_seoul_hour,'**')`이며 가장 높은 값이 기록된 시간은 각각
`r asdf$측정시간` 와 `r asdf2$측정시간` 입니다.   
  
또한, 
`r year_2021` ~ `r year_2021_2`에서 기온, 습도가 가장 높은 값은 각각 
`r paste0('**',max_temp_tsv_2_seoul_hour,'**')`, 
`r paste0('**',max_humid_tsv_2_seoul_hour,'**')`이며 가장 높은 값이 기록된 시간은 각각
`r asdf3$측정시간`와 `r asdf4$측정시간`입니다. 

```{r, warning= FALSE, message=F, echo = FALSE, dpi=300}


rm(asdf)
rm(asdf2)
rm(asdf3)
rm(asdf4)


before_year <-paste0(year_2020, " ~ ", year_2020_2)
after_year <-paste0(year_2021, " ~ ", year_2021_2)



tsv_1_seoul_hour_temp$비교날짜 <- before_year
tsv_2_seoul_hour_temp$비교날짜 <- after_year

tsv_1_seoul_hour_humid$비교날짜 <- before_year
tsv_2_seoul_hour_humid$비교날짜 <- after_year


a_b_temp <- rbind(tsv_1_seoul_hour_temp,tsv_2_seoul_hour_temp)
a_b_humid <- rbind(tsv_1_seoul_hour_humid,tsv_2_seoul_hour_humid)


#20,21 기온 분포 비교
ggplot(data = a_b_temp, aes(x = 기온, group = 비교날짜, colour = 비교날짜, fill = 비교날짜)) + # fill/colour aes is not required
  geom_density(alpha = 0.6) +
  labs(title = "기온 비교")+
  labs(y="기온 분포") +
  labs(x="기온") +

  theme_bw() +
  theme(text=element_text(family="NanumGothic"))

#20,21 습도분포 비교
ggplot(data = a_b_humid, aes(x = 습도, group = 비교날짜, colour = 비교날짜, fill = 비교날짜)) + # fill/colour aes is not required
  geom_density(alpha = 0.6) +
  labs(title = "습도 비교")+
  labs(y="습도 분포") +
  labs(x="습도") +

  theme_bw() +
  theme(text=element_text(family="NanumGothic"))

rm(a_b_humid)
rm(a_b_temp)
gc()

```

  
# 서울시 폭염주의보, 경보
```{r, warning= FALSE, message=F, echo = FALSE, dpi=300}





#before

tsv_1_gover_day_temp_max <- tsv_1 %>% group_by(date,측정시간) %>% summarise(기온 = mean(`기온 (℃)`,na.rm = TRUE))
tsv_1_gover_day_temp_max <- tsv_1 %>% group_by(date) %>% summarise(기온 = max(`기온 (℃)`,na.rm = TRUE))


tsv_2_gover_day_temp_max <- tsv_2 %>% group_by(date,측정시간) %>% summarise(기온 = mean(`기온 (℃)`,na.rm = TRUE))
tsv_2_gover_day_temp_max <- tsv_2 %>% group_by(date) %>% summarise(기온 = max(`기온 (℃)`,na.rm = TRUE))


#폭염 주의보 경보
conc_t_adv1 <- find_news(tsv_1_gover_day_temp_max,33)
conc_t_adv2 <- find_news(tsv_2_gover_day_temp_max,33)

conc_t_wa1 <- find_news(tsv_1_gover_day_temp_max,35)
conc_t_wa2 <- find_news(tsv_2_gover_day_temp_max,35)





```  
`r before_year`에서 폭염 주의보는`r conc_t_adv1` 동안 발생 하였다. 


`r after_year`에서 폭염 주의보는 `r conc_t_adv2` 동안 발생 하였다. 


  
`r before_year`에서 폭염 경보는`r conc_t_wa1` 동안 발생 하였다. 


`r after_year`에서 폭염 경보는 `r conc_t_wa2` 동안 발생 하였다.   





# 서울시 자치구 일별 온습도 막대 그래프
```{r, warning= FALSE, message=F, echo = FALSE, dpi=200, fig.width=9, fig.height=80}

#자치구 일별 기온 습도
tsv_1_gover_day_temp <- tsv_1 %>% group_by(date,gover) %>% summarise(기온 = mean(`기온 (℃)`,na.rm = TRUE))
tsv_2_gover_day_temp <- tsv_2 %>% group_by(date,gover) %>% summarise(기온 = mean(`기온 (℃)`,na.rm = TRUE))

tsv_1_gover_day_humid <- tsv_1 %>% group_by(date,gover) %>% summarise(습도 = mean(`상대습도 (%)`,na.rm = TRUE))
tsv_2_gover_day_humid <- tsv_2 %>% group_by(date,gover) %>% summarise(습도 = mean(`상대습도 (%)`,na.rm = TRUE))



#TEMP, HUMID MELT

#temp
tsv_1_gover_day_temp <- melt(tsv_1_gover_day_temp, id.vars=c('date','gover'))
tsv_2_gover_day_temp <- melt(tsv_2_gover_day_temp, id.vars=c('date','gover'))
tsv_3_gover_day_temp <- rbind(tsv_1_gover_day_temp,tsv_2_gover_day_temp)

tsv_3_gover_day_temp_2020 <- tsv_3_gover_day_temp %>% filter(date >= year_2020 & date <=year_2020_2)
tsv_3_gover_day_temp_2021 <- tsv_3_gover_day_temp %>% filter(date >= year_2021 & date <=year_2021_2)

#humid
tsv_1_gover_day_humid <- melt(tsv_1_gover_day_humid, id.vars=c('date','gover'))
tsv_2_gover_day_humid <- melt(tsv_2_gover_day_humid, id.vars=c('date','gover'))
tsv_3_gover_day_humid <- rbind(tsv_1_gover_day_humid,tsv_2_gover_day_humid)

tsv_3_gover_day_humid_2020 <- tsv_3_gover_day_humid %>% filter(date >= year_2020 & date <=year_2020_2)
tsv_3_gover_day_humid_2021 <- tsv_3_gover_day_humid %>% filter(date >= year_2021 & date <=year_2021_2)

###


p1_temp <-ggplot(tsv_3_gover_day_temp_2020, aes(x=date, y=value, fill=variable)) +
  geom_bar(stat="identity",show.legend=TRUE, colour="black",width = 0.5) +
  geom_text(aes(y=value, label = format(round(value, 0), nsmall=0)), size=4, vjust=-0.25) +
  
  ylab('기온') + 
  
  labs(title=paste0(year_2020,"~",year_2020_2, " 기온")) +
  scale_x_date(date_breaks = "day", date_labels =  "%y-%m-%d") +
  theme_bw() + 
  theme(text=element_text(family="NanumGothic"),legend.position = "top") +
  facet_wrap(~gover, ncol = 1,scales = "free_x") 


#####


#####


gu_buttons <- list()
for (i in 1:length(gu_name$gover)) { 
  gu_buttons[[i]] <- list(method = "restyle",
                           args = list(gu_name$gover[i]),
                           label = gu_name$gover[i])
}




fig <- plot_ly(tsv_3_gover_day_temp_2020)
fig <- fig %>% add_bars(x = ~date,y = ~value) %>% add_trace(y = ~gover)


fig <- fig %>% layout(
  title = "Button Restyle",
  xaxis = list(domain = c(0.1, 1)),
  yaxis = list(title = "y"),
  updatemenus = list(
    list(
     active = 2, x = 0, y = 0.8, 
    buttons=gu_buttons
     
  ))
)
fig



 ##### 
p2_temp <-ggplot(tsv_3_gover_day_temp_2021, aes(x=date, y=value, fill=variable)) +
  geom_bar(stat="identity",show.legend=TRUE, colour="black",width = 0.5) +
  geom_text(aes(y=value, label = format(round(value, 0), nsmall=0)), size=4, vjust=-0.25) +
  
  ylab('기온') + 
  
  labs(title=paste0(year_2021,"~",year_2021_2, " 기온")) +
  scale_x_date(date_breaks = "day", date_labels =  "%y-%m-%d") +
  theme_bw() + 
  theme(text=element_text(family="NanumGothic"),legend.position = "top") +
  facet_wrap(~gover, ncol = 1,scales = "free_x") 

p_temp<-ggarrange(p1_temp, p2_temp,    ncol = 2)
p_temp

rm(p_temp)

p1_humid <-ggplot(tsv_3_gover_day_humid_2020, aes(x=date, y=value, fill=variable)) +
  geom_bar(stat="identity",show.legend=TRUE, colour="black",width = 0.5,fill = 'royalblue') +
  geom_text(aes(y=value, label = format(round(value, 0), nsmall=0)), size=4, vjust=-0.25) +
  
  ylab('습도') + 
  
  labs(title=paste0(year_2020,"~",year_2020_2, " 상대습도")) +
  scale_x_date(date_breaks = "day", date_labels =  "%y-%m-%d") +
  theme_bw() + 
  theme(text=element_text(family="NanumGothic"),legend.position = "top") +
  facet_wrap(~gover, ncol = 1,scales = "free_x") 

p2_humid <-ggplot(tsv_3_gover_day_humid_2021, aes(x=date, y=value, fill=variable)) +
  geom_bar(stat="identity",show.legend=TRUE, colour="black",width = 0.5,fill = 'royalblue') +
  geom_text(aes(y=value, label = format(round(value, 0), nsmall=0)), size=4, vjust=-0.25) +
  
  ylab('습도') + 
  
  labs(title=paste0(year_2021,"~",year_2021_2, " 상대습도")) +
  scale_x_date(date_breaks = "day", date_labels =  "%y-%m-%d") +
  theme_bw() + 
  theme(text=element_text(family="NanumGothic"),legend.position = "top") +
  facet_wrap(~gover, ncol = 1,scales = "free_x") 

p_humid<-ggarrange(p1_humid, p2_humid,    ncol = 2)
p_humid


rm(p_humid)
rm(tsv_1_gover_day_humid)
rm(tsv_1_gover_day_temp)

rm(tsv_2_gover_day_humid)
rm(tsv_2_gover_day_temp)

rm(tsv_3_gover_day_humid)
rm(tsv_3_gover_day_humid_2020)
rm(tsv_3_gover_day_humid_2021)

rm(tsv_3_gover_day_temp)
rm(tsv_3_gover_day_temp_2020)
rm(tsv_3_gover_day_temp_2021)

gc()

```






# 서울시 자치구별 기간 전체 평균 지도
```{r, warning= FALSE, message=F, echo = FALSE, dpi=200, fig.width=8, fig.height=8}
#지도 시작
#지도의 경우 서울시 전체를 하는것이 의미가 없음(자치구 별 = 서울시 전체)
#따라서 자치구 단계부터 지도를 그리기 시작하도록 한다. 

#지도 shp불러오기 시작
map <- shapefile("basic_data/시군구/TL_SCCO_SIG.shp")
map <- spTransform(map, CRSobj = CRS('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs'))
new_map <- fortify(map, region = 'SIG_CD')
new_map$id <- as.numeric(new_map$id)

rm(map)

#시군구 코드 11740 이하의 값이 서울시에 포함된 자치구임
seoul_map <- new_map[new_map$id<=11740,]
rm(new_map)

#자치구 코드파일 불러오기
gover_code <- read.csv('basic_data/gover_code.csv')

#1. 5.6~5.9 기간 전체 평균 

#미세먼지부터 
tsv1_gu_pm10_seoul_map <- tsv_1 %>% group_by(gover) %>% summarise(미세먼지 =mean(`미세먼지 보정 (㎍/㎥)`, na.rm =TRUE ))
tsv1_gu_pm10_seoul_map$gover <- as.character(tsv1_gu_pm10_seoul_map$gover)

tsv1_merge_pm10_seoul_map<- merge(tsv1_gu_pm10_seoul_map,gover_code,by="gover")
tsv1_merge_pm10_seoul_map$id <- as.numeric(tsv1_merge_pm10_seoul_map$id)
tsv1_merge_pm10_seoul_map <- merge(seoul_map,tsv1_merge_pm10_seoul_map,by='id')

#자치구 이름
#gu_name <- tsv1_merge_pm10_seoul_map %>% group_by(gover) %>% summarise(long =mean(`long`, na.rm =TRUE ),lat=mean(`lat`,na.rm = TRUE))


gu_name <- read.csv('gu_name.csv')
# 
# 
# gu_name_value <- merge(gu_name,tsv1_gu_pm10_seoul_map, by = 'gover')
# gu_name_value$미세먼지 <- round(gu_name_value$미세먼지,1)

###################################
#먼지끝 기온 습도 시작 
##################################

# t_dot <- read.csv('전체장비리스트_20210730.csv')
# 
# names(t_dot)[4] <- c('l')
# 
# t <- ggplot(t_dot, aes(x=long, y = lat))+
#   geom_polygon(data = seoul_map,colour = 'black' ,aes(x=long, y=lat, group=group),fill = NA) +
#   geom_point(data = t_dot, mapping = aes(),colour = "red")+
# 
#   
#  register_google(key = 'AIzaSyB2rVdy92xtDzCe3DQkq0JuaeX6cEFFc-o')
# 
# names(t_dot)[4] <- c('l')
# getmap <- get_googlemap("seoul",maptype = 'roadmap',zoom = 11)
# p1 <- ggmap(getmap)
# p2 <- p1 +
#   geom_polygon(data = seoul_map,colour = 'black' ,aes(x=long, y=lat, group=group),fill = NA) +
#   geom_point(data = t_dot, mapping =  aes(x=lat, y = long),colour = "blue", size = 1.5)


#2020년 자치구별 기온 (일별아님)
tsv1_gu_temp_seoul_map <- tsv_1 %>% group_by(gover) %>% summarise(기온 =mean(`기온 (℃)`, na.rm =TRUE ))
tsv1_gu_temp_seoul_map$gover <- as.character(tsv1_gu_temp_seoul_map$gover)

tsv1_merge_temp_seoul_map<- merge(tsv1_gu_temp_seoul_map,gover_code,by="gover")
tsv1_merge_temp_seoul_map$id <- as.numeric(tsv1_merge_temp_seoul_map$id)
tsv1_merge_temp_seoul_map <- merge(seoul_map,tsv1_merge_temp_seoul_map,by='id')
gu_name_value <- merge(gu_name,tsv1_gu_temp_seoul_map, by = 'gover')
gu_name_value$기온 <- round(gu_name_value$기온,1)

rm(tsv1_gu_temp_seoul_map)

#tsv1_merge_temp_seoul_map$기온 <- round(tsv1_merge_temp_seoul_map$기온,0)
plotp <- ggplot()+
  geom_polygon(data = tsv1_merge_temp_seoul_map,colour = 'black' ,aes(x=long, y=lat, group=group ,fill =기온)) +
  scale_fill_gradient(low = "#ffe5e5", high = "#ff3232",space = "Lab",guide = "colourbar") +
  theme_bw() + 
  geom_text(data = gu_name_value , aes(x=long, y=lat, label = paste(gover,기온,sep = '\n')),size = 3, vjust = -0.25)+
  labs(title = "2020년 서울시 자치구별 평균기온")

plotp
rm(tsv1_merge_temp_seoul_map)
rm(plotp)

#2021년 자치구별 기온 (일별아님)
tsv2_gu_temp_seoul_map <- tsv_2 %>% group_by(gover) %>% summarise(기온 =mean(`기온 (℃)`, na.rm =TRUE ))
tsv2_gu_temp_seoul_map$gover <- as.character(tsv2_gu_temp_seoul_map$gover)

tsv2_merge_temp_seoul_map<- merge(tsv2_gu_temp_seoul_map,gover_code,by="gover")
tsv2_merge_temp_seoul_map$id <- as.numeric(tsv2_merge_temp_seoul_map$id)
tsv2_merge_temp_seoul_map <- merge(seoul_map,tsv2_merge_temp_seoul_map,by='id')
gu_name_value <- merge(gu_name,tsv2_gu_temp_seoul_map, by = 'gover')
gu_name_value$기온 <- round(gu_name_value$기온,2)

rm(tsv2_gu_temp_seoul_map)

tsv2_merge_temp_seoul_map$기온 <- round(tsv2_merge_temp_seoul_map$기온,1)
plotp <- ggplot()+
  geom_polygon(data = tsv2_merge_temp_seoul_map,colour = 'black' ,aes(x=long, y=lat, group=group ,fill =기온)) +
  scale_fill_gradient(low = "#ffe5e5", high = "#ff3232",space = "Lab",guide = "colourbar") +
  theme_bw() + 
  geom_text(data = gu_name_value , aes(x=long, y=lat, label = paste(gover,기온,sep = '\n')),size = 3, vjust = -0.25)+
  labs(title = "2021년 서울시 자치구별 평균기온")

plotp
rm(tsv2_merge_temp_seoul_map)
rm(plotp)


#2020년 자치구별 습도 (일별아님)
tsv1_gu_humid_seoul_map <- tsv_1 %>% group_by(gover) %>% summarise(습도 =mean(`상대습도 (%)`, na.rm =TRUE ))
tsv1_gu_humid_seoul_map$gover <- as.character(tsv1_gu_humid_seoul_map$gover)

tsv1_merge_humid_seoul_map<- merge(tsv1_gu_humid_seoul_map,gover_code,by="gover")
tsv1_merge_humid_seoul_map$id <- as.numeric(tsv1_merge_humid_seoul_map$id)
tsv1_merge_humid_seoul_map <- merge(seoul_map,tsv1_merge_humid_seoul_map,by='id')
gu_name_value <- merge(gu_name,tsv1_gu_humid_seoul_map, by = 'gover')
gu_name_value$습도 <- round(gu_name_value$습도,1)

rm(tsv1_gu_humid_seoul_map)

#tsv1_merge_temp_seoul_map$기온 <- round(tsv1_merge_temp_seoul_map$기온,0)
plotp <- ggplot()+
  geom_polygon(data = tsv1_merge_humid_seoul_map,colour = 'black' ,aes(x=long, y=lat, group=group ,fill =습도)) +
  scale_fill_gradient(low = "skyblue", high = "royalblue",space = "Lab",guide = "colourbar") +
  theme_bw() + 
  geom_text(data = gu_name_value , aes(x=long, y=lat, label = paste(gover,습도,sep = '\n')),size = 3, vjust = -0.25)+
  labs(title = "2020년 서울시 자치구별 평균습도")

plotp
rm(tsv1_merge_humid_seoul_map)
rm(plotp)

#2021년 자치구별 습도 (일별아님)
tsv2_gu_humid_seoul_map <- tsv_2 %>% group_by(gover) %>% summarise(습도 =mean(`상대습도 (%)`, na.rm =TRUE ))
tsv2_gu_humid_seoul_map$gover <- as.character(tsv2_gu_humid_seoul_map$gover)

tsv2_merge_humid_seoul_map<- merge(tsv2_gu_humid_seoul_map,gover_code,by="gover")
tsv2_merge_humid_seoul_map$id <- as.numeric(tsv2_merge_humid_seoul_map$id)
tsv2_merge_humid_seoul_map <- merge(seoul_map,tsv2_merge_humid_seoul_map,by='id')
gu_name_value <- merge(gu_name,tsv2_gu_humid_seoul_map, by = 'gover')
gu_name_value$습도 <- round(gu_name_value$습도,1)

rm(tsv2_gu_humid_seoul_map)

#tsv1_merge_temp_seoul_map$기온 <- round(tsv1_merge_temp_seoul_map$기온,0)
plotp <- ggplot()+
  geom_polygon(data = tsv2_merge_humid_seoul_map,colour = 'black' ,aes(x=long, y=lat, group=group ,fill =습도)) +
  scale_fill_gradient(low = "skyblue", high = "royalblue",space = "Lab",guide = "colourbar") +
  theme_bw() + 
  geom_text(data = gu_name_value , aes(x=long, y=lat, label = paste(gover,습도,sep = '\n')),size = 3, vjust = -0.25,facetext = 'bold')+
  labs(title = "2021년 서울시 자치구별 평균습도")

plotp
rm(tsv2_merge_humid_seoul_map)
rm(plotp)

rm(p)
rm(p1)
rm(p2)
rm(p1_humid)
rm(p2_humid)
rm(p1_temp)
rm(p2_temp)

gc()


```



# 서울시 자치구 일별 평균 지도
```{r, warning= FALSE, message=F, echo = FALSE, dpi=200, fig.width=20, fig.height=20}
#2020년 자치구별 기온 (일별임)
tsv1_gu_temp_day_map <- tsv_1 %>% group_by(gover,date) %>% summarise(기온 =mean(`기온 (℃)`, na.rm =TRUE ))
tsv1_gu_temp_day_map$gover <- as.character(tsv1_gu_temp_day_map$gover)

tsv1_merge_temp_day_map<- merge(tsv1_gu_temp_day_map,gover_code,by="gover")
tsv1_merge_temp_day_map$id <- as.numeric(tsv1_merge_temp_day_map$id)
tsv1_merge_temp_day_map <- merge(seoul_map,tsv1_merge_temp_day_map,by='id')
gu_name_value <- merge(gu_name,tsv1_gu_temp_day_map, by = 'gover')
gu_name_value$기온 <- round(gu_name_value$기온,1)

rm(tsv1_gu_temp_day_map)

plotp <- ggplot()+
  geom_polygon(data = tsv1_merge_temp_day_map,colour = 'black' ,aes(x=long, y=lat,group=group ,fill =기온,frame = date)) +
  scale_fill_gradient(low = "#ffe5e5", high = "#ff3232",guide = "colourbar") +
  #scale_fill_manual(name = "예보등급",values =c("royalblue","green","yellow","red"),breaks = c(1,2,3,4), labels = c("좋음(0~30)","보통(31~80)","나쁨(81~150)","매우나쁨(151~)"))+
  theme_bw() + 
  geom_text(data = gu_name_value , aes(x=long, y=lat, label = paste(gover,기온,sep = '\n'),frame = date),size = 6, vjust = -0.25)+
  labs(title = "2020년 서울시 일별, 자치구별 기온 평균")

plotp
rm(plotp)
rm(tsv1_merge_pm10_day_map)



#plot2 <- ggplotly(plotp) %>% animation_opts(transition = 0, redraw = TRUE) %>% animation_slider(currentvalue = list(prefix = "date", font = list(color = "orange"))) 



#2021년 자치구별 기온 (일별임)
tsv2_gu_temp_day_map <- tsv_2 %>% group_by(gover,date) %>% summarise(기온 =mean(`기온 (℃)`, na.rm =TRUE ))
tsv2_gu_temp_day_map$gover <- as.character(tsv2_gu_temp_day_map$gover)

tsv2_merge_temp_day_map<- merge(tsv2_gu_temp_day_map,gover_code,by="gover")
tsv2_merge_temp_day_map$id <- as.numeric(tsv2_merge_temp_day_map$id)
tsv2_merge_temp_day_map <- merge(seoul_map,tsv2_merge_temp_day_map,by='id')
gu_name_value <- merge(gu_name,tsv2_gu_temp_day_map, by = 'gover')
gu_name_value$기온 <- round(gu_name_value$기온,1)

rm(tsv2_gu_temp_day_map)

plotp <- ggplot()+
  geom_polygon(data = tsv2_merge_temp_day_map,colour = 'black' ,aes(x=long, y=lat, group=group ,fill =기온)) +
  scale_fill_gradient(low = "#ffe5e5", high = "#ff3232",space = "Lab",guide = "colourbar") +
  theme_bw() + 
  facet_wrap(~date,scales = "free_x")+

  geom_text(data = gu_name_value , aes(x=long, y=lat, label = paste(gover,기온,sep = '\n')),size = 6, vjust = -0.25)+
  labs(title = "2021년 서울시 일별, 자치구별 기온 평균")

plotp
rm(plotp)
rm(tsv2_merge_pm10_day_map)


#2020년 자치구별 습도 (일별임)
tsv1_gu_hm_day_map <- tsv_1 %>% group_by(gover,date) %>% summarise(습도 =mean(`상대습도 (%)`, na.rm =TRUE ))
tsv1_gu_hm_day_map$gover <- as.character(tsv1_gu_hm_day_map$gover)

tsv1_merge_hm_day_map<- merge(tsv1_gu_hm_day_map,gover_code,by="gover")
tsv1_merge_hm_day_map$id <- as.numeric(tsv1_merge_hm_day_map$id)
tsv1_merge_hm_day_map <- merge(seoul_map,tsv1_merge_hm_day_map,by='id')
gu_name_value <- merge(gu_name,tsv1_gu_hm_day_map, by = 'gover')
gu_name_value$습도 <- round(gu_name_value$습도,1)

rm(tsv1_gu_hm_day_map)

plotp <- ggplot()+
  geom_polygon(data = tsv1_merge_hm_day_map,colour = 'black' ,aes(x=long, y=lat, group=group ,fill =습도)) +
  scale_fill_gradient(low = "skyblue", high = "royalblue",space = "Lab",guide = "colourbar") +
  theme_bw() + 
  facet_wrap(~date,scales = "free_x")+

  geom_text(data = gu_name_value , aes(x=long, y=lat, label = paste(gover,습도,sep = '\n')),size = 6, vjust = -0.25)+
  labs(title = "2020년 서울시 일별, 자치구별 습도 평균")

plotp
rm(plotp)
rm(tsv1_merge_pm10_day_map)


#2021년 자치구별 습도 (일별임)
tsv2_gu_hm_day_map <- tsv_2 %>% group_by(gover,date) %>% summarise(습도 =mean(`상대습도 (%)`, na.rm =TRUE ))
tsv2_gu_hm_day_map$gover <- as.character(tsv2_gu_hm_day_map$gover)

tsv2_merge_hm_day_map<- merge(tsv2_gu_hm_day_map,gover_code,by="gover")
tsv2_merge_hm_day_map$id <- as.numeric(tsv2_merge_hm_day_map$id)
tsv2_merge_hm_day_map <- merge(seoul_map,tsv2_merge_hm_day_map,by='id')
gu_name_value <- merge(gu_name,tsv2_gu_hm_day_map, by = 'gover')
gu_name_value$습도 <- round(gu_name_value$습도,1)

rm(tsv2_gu_hm_day_map)

plotp <- ggplot()+
  geom_polygon(data = tsv2_merge_hm_day_map,colour = 'black' ,aes(x=long, y=lat, group=group ,fill =습도)) +
  scale_fill_gradient(low = "skyblue", high = "royalblue",space = "Lab",guide = "colourbar") +
  theme_bw() + 
  facet_wrap(~date,scales = "free_x")+

  geom_text(data = gu_name_value , aes(x=long, y=lat, label = paste(gover,습도,sep = '\n')),size = 6, vjust = -0.25)+
  labs(title = "2021년 서울시 일별, 자치구별 습도 평균")

plotp
rm(plotp)
rm(tsv1_merge_pm10_day_map)


rm(tsv_1_seoul_hour_conclusion_nrow_pm10)
rm(tsv_1_seoul_hour_conclusion_nrow_pm2)

rm(tsv_2_seoul_hour_conclusion_nrow_pm10)
rm(tsv_2_seoul_hour_conclusion_nrow_pm2)

rm(tsv_1_seoul_hour_nrow)
rm(tsv_2_seoul_hour_nrow)

gc()

```


#꺾은선 자치구 시간별
```{r, warning= FALSE, message=F, echo = FALSE, dpi=200, fig.width=10, fig.height=90}

#일별_시간별_온습도_평균데이터
tsv_1_seoul_hour_temp <- tsv_1 %>% group_by(gover,측정시간,date) %>% summarise(기온 =mean(`기온 (℃)`, na.rm =TRUE ))
tsv_2_seoul_hour_temp <- tsv_2 %>% group_by(gover,측정시간,date) %>% summarise(기온 =mean(`기온 (℃)`, na.rm =TRUE ))

tsv_1_seoul_hour_humid <- tsv_1 %>% group_by(gover,측정시간,date) %>% summarise(습도 =mean(`상대습도 (%)`, na.rm =TRUE ))
tsv_2_seoul_hour_humid <- tsv_2 %>% group_by(gover,측정시간,date) %>% summarise(습도 =mean(`상대습도 (%)`, na.rm =TRUE ))


#일별_시간별_온습도_반올림
tsv_1_seoul_hour_temp$기온 <- round(tsv_1_seoul_hour_temp$기온) 
tsv_2_seoul_hour_temp$기온 <- round(tsv_2_seoul_hour_temp$기온) 

tsv_1_seoul_hour_humid$습도 <- round(tsv_1_seoul_hour_humid$습도) 
tsv_2_seoul_hour_humid$습도 <- round(tsv_2_seoul_hour_humid$습도) 


#서울시 전체 시간별 온도 2020
p_seoul_hour_temp1 <- ggplot(tsv_1_seoul_hour_temp, aes(x=측정시간)) + 
  
  geom_line(aes(y = 기온), color = "red", linetype="solid") + 
  geom_point(aes(y = 기온), colour = "steelblue", size = 0.7) +
  
  geom_text(aes(y=기온,label= round(기온, digits = 0)), vjust = -3, size = 2) +
  theme(legend.position = "right") +
  
  ggtitle(paste0(year_2020,"~",year_2020_2, "서울 시간별 평균 기온"))  + ylab("기온") +
  theme_bw() +
  theme(text=element_text(family="NanumGothic"),axis.text.x = element_text(angle=90, hjust=1)) +
  scale_x_datetime( date_breaks= "6 hour", date_minor_breaks= "6 hours",
                    labels = date_format("%y-%m-%d %H:%M", tz= "UTC"), 
                    expand = c(0,0))+
  facet_wrap(~gover,ncol = 1,scale = "free")


#서울시 전체 시간별 온도 2021
p_seoul_hour_temp2 <- ggplot(tsv_2_seoul_hour_temp, aes(x=측정시간)) + 
  
  geom_line(aes(y = 기온), color = "red", linetype="solid") + 
  geom_point(aes(y = 기온), colour = "steelblue", size = 0.7) +
  
  geom_text(aes(y=기온,label= round(기온, digits = 0)), vjust = -3, size = 2) +
  theme(legend.position = "right") +
  #scale_color_manual(values = c('Y1' = 'darkblue','Y2' = 'red')) + labs(color = 'Y series') +
  
  #scale_x_date(date_breaks = "day", date_labels =  "%y-%m-%d") +
  
  ggtitle(paste0(year_2021,"~",year_2021_2, "서울 시간별 평균 기온"))  + ylab("기온") +
  theme_bw() +
  theme(text=element_text(family="NanumGothic"),axis.text.x = element_text(angle=90, hjust=1)) +
  scale_x_datetime( date_breaks= "6 hour", date_minor_breaks= "6 hours",
                    labels = date_format("%y-%m-%d %H:%M", tz= "UTC"), 
                                        expand = c(0,0))+
  facet_wrap(~gover,ncol=1,scale = "free")

p <- ggarrange(p_seoul_hour_temp1,p_seoul_hour_temp2)
p


```

```{r, warning= FALSE, message=F, echo = FALSE, dpi=200, fig.width=10, fig.height=90}


#서울시 전체 시간별 습도 2020
p_seoul_hour_humid1 <- ggplot(tsv_1_seoul_hour_humid, aes(x=측정시간)) + 
  
  geom_line(aes(y = 습도), color = "royalblue", linetype="solid") + 
  geom_point(aes(y = 습도), colour = "steelblue", size = 0.7) +
  
  geom_text(aes(y=습도,label= round(습도, digits = 0)), vjust = -3, size = 2) +
  theme(legend.position = "right") +
  #scale_color_manual(values = c('Y1' = 'darkroyalblue','Y2' = 'red')) + labs(color = 'Y series') +
  
  #scale_x_date(date_breaks = "day", date_labels =  "%y-%m-%d") +
  
  ggtitle(paste0(year_2020,"~",year_2020_2, "서울 시간별 평균 상대습도"))  + ylab("습도") +
  theme_bw() +
  theme(text=element_text(family="NanumGothic"),axis.text.x = element_text(angle=90, hjust=1)) +
  scale_x_datetime( date_breaks= "6 hour", date_minor_breaks= "2 hours",
                    labels = date_format("%y-%m-%d %H:%M", tz= "UTC"), 
                    expand = c(0,0))+
  facet_wrap(~gover,ncol=1,scale = "free")


#서울시 전체 시간별 습도 2021
p_seoul_hour_humid2 <- ggplot(tsv_2_seoul_hour_humid, aes(x=측정시간)) + 
  
  geom_line(aes(y = 습도), color = "royalblue", linetype="solid") + 
  geom_point(aes(y = 습도), colour = "steelblue", size = 0.7) +
  
  geom_text(aes(y=습도,label= round(습도, digits = 0)), vjust = -3, size = 2) +
  theme(legend.position = "right") +
  #scale_color_manual(values = c('Y1' = 'darkroyalblue','Y2' = 'red')) + labs(color = 'Y series') +
  
  #scale_x_date(date_breaks = "day", date_labels =  "%y-%m-%d") +
  
  ggtitle(paste0(year_2021,"~",year_2021_2, "서울 시간별 평균 상대습도"))  + ylab("습도") +
  theme_bw() +
  theme(text=element_text(family="NanumGothic"),axis.text.x = element_text(angle=90, hjust=1)) +
  scale_x_datetime( date_breaks= "6 hour", date_minor_breaks= "2 hours",
                    labels = date_format("%y-%m-%d %H:%M", tz= "UTC"), 
                    expand = c(0,0))+
  facet_wrap(~gover,ncol = 1,scale = "free")




p <- ggarrange(p_seoul_hour_humid1,p_seoul_hour_humid2)
p

rm(p)
rm(p_seoul_hour_temp1)
rm(p_seoul_hour_temp2)
rm(p_seoul_hour_humid1)
rm(p_seoul_hour_humid2)


gc()

```


